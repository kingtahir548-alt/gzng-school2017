<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†ÛŒ Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Rabar_021&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-body: #f4f6f9;
            --sidebar-bg: #1e293b;
            --primary: #3b82f6; /* Blue like screenshot */
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --white: #ffffff;
            --text-dark: #1f2937;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Rabar_021', 'Segoe UI', sans-serif;
            background-color: var(--bg-body);
            margin: 0; padding: 0; color: var(--text-dark);
        }

        /* --- Header & Nav --- */
        header {
            background: var(--white);
            padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; object-fit: contain; }
        .app-title { font-weight: bold; font-size: 1.2em; color: var(--text-dark); }

        .nav-links { display: flex; gap: 20px; }
        .nav-btn {
            background: none; border: none; padding: 10px 15px;
            font-family: inherit; font-size: 1em; color: var(--secondary);
            cursor: pointer; transition: 0.3s; border-radius: 8px; font-weight: bold;
        }
        .nav-btn:hover { background: #f1f5f9; color: var(--primary); }
        .nav-btn.active { background: #eff6ff; color: var(--primary); }
        .nav-btn.btn-logout { color: var(--danger); }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* --- DASHBOARD STATS (Like Screenshot 1) --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--white); padding: 20px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px;
            border-bottom: 4px solid transparent;
        }
        .stat-card.blue { border-color: var(--primary); }
        .stat-card.green { border-color: var(--success); }
        .stat-card.orange { border-color: var(--warning); }
        
        .stat-icon {
            width: 50px; height: 50px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; color: white;
        }
        .stat-info h3 { margin: 0; font-size: 1.8em; }
        .stat-info p { margin: 0; color: var(--secondary); font-size: 0.9em; }

        /* --- ADMIN TABLE (Like Screenshot 1) --- */
        .table-container {
            background: var(--white); border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden;
        }
        .table-header {
            padding: 20px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .table-header h3 { margin: 0; color: var(--text-dark); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 15px 20px; background: #f8fafc; color: var(--secondary); font-size: 0.9em; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 0.95em; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f8fafc; }

        .status-badge {
            background: #dcfce7; color: #166534; padding: 4px 10px;
            border-radius: 20px; font-size: 0.8em; font-weight: bold;
        }

        .action-btns { display: flex; gap: 8px; }
        .btn-icon {
            padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-color);
            background: white; cursor: pointer; color: var(--secondary); transition: 0.2s;
        }
        .btn-icon:hover { background: var(--bg-body); color: var(--primary); border-color: var(--primary); }
        .btn-icon.print { color: var(--warning); border-color: var(--warning); }
        .btn-icon.print:hover { background: #fffbeb; }
        .btn-icon.delete { color: var(--danger); border-color: var(--danger); }
        .btn-icon.delete:hover { background: #fef2f2; }

        /* --- FORMS (Modern Clean) --- */
        .form-card {
            background: var(--white); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-width: 700px; margin: 0 auto;
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-dark); }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; font-family: inherit; font-size: 15px;
            transition: 0.2s; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 12px 25px; border-radius: 8px; font-weight: bold;
            cursor: pointer; width: 100%; font-size: 1em; transition: 0.2s;
        }
        .btn-primary:hover { background: #2563eb; }

        /* --- PUBLIC CARD GRID --- */
        .grid-cards {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .public-card {
            background: var(--white); border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 4px solid var(--primary);
        }
        .pc-head { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        .pc-body { padding: 20px; }
        .pc-meta { display: flex; gap: 10px; margin-bottom: 15px; font-size: 0.9em; color: var(--secondary); }
        .badge { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; }

        /* --- A4 REPORT (Like Screenshot 2) --- */
        #hafba-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; display: flex;
            align-items: center; justify-content: center;
        }
        
        .modal-sidebar {
            width: 300px; background: white; height: 100%; padding: 20px;
            box-sizing: border-box; display: flex; flex-direction: column; gap: 15px;
            border-left: 1px solid #ddd;
        }

        .modal-content {
            flex: 1; height: 100%; overflow-y: auto; background: #525659;
            display: flex; justify-content: center; padding: 40px;
        }

        .a4-page {
            width: 210mm; min-height: 297mm; background: white;
            padding: 20mm; box-sizing: border-box; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Document Style A4 */
        .doc-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px double #333; padding-bottom: 20px; margin-bottom: 30px;
        }
        .doc-logo img { width: 90px; height: 90px; }
        .doc-title { text-align: center; flex: 1; }
        .doc-title h1 { margin: 0; font-size: 24px; color: #000; letter-spacing: 1px; }
        .doc-title p { margin: 5px 0 0 0; font-size: 14px; color: #555; }

        .doc-info-box {
            background: #f8fafc; border: 1px solid #e2e8f0;
            border-right: 5px solid var(--primary);
            padding: 20px; margin-bottom: 30px; border-radius: 4px;
        }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; border-bottom: 1px dashed #ddd; padding-bottom: 5px;}
        .info-row:last-child { border-bottom: none; }
        .info-label { font-weight: bold; color: #64748b; }
        .info-val { font-weight: bold; color: #000; }

        .doc-desc {
            font-size: 16px; line-height: 1.8; text-align: justify;
            margin-bottom: 30px; min-height: 100px;
        }

        .doc-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            margin-top: auto;
        }
        .doc-img {
            height: 230px; border: 1px solid #000; background: #eee;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .doc-img img { width: 100%; height: 100%; object-fit: cover; }

        .doc-footer {
            position: absolute; bottom: 15px; left: 0; width: 100%;
            text-align: center; font-size: 12px; color: #999;
            border-top: 1px solid #eee; padding-top: 10px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #hafba-modal, #hafba-modal * { visibility: visible; }
            .modal-sidebar { display: none; }
            .modal-content { background: white; padding: 0; overflow: visible; }
            .a4-page { box-shadow: none; margin: 0; width: 100%; height: 100%; }
            #hafba-modal { position: absolute; left: 0; top: 0; background: white; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header class="no-print">
    <div class="logo-area">
        <img src="https://i.ibb.co/VY75GyWf/logo.png" alt="Logo" class="logo-img">
        <span class="app-title">Ú¯Ø²Ù†Ú¯</span>
    </div>
    <div class="nav-links">
        <button class="nav-btn active" onclick="showTab('home')">ğŸ  Ø³Û•Ø±Û•Ú©ÛŒ</button>
        <button class="nav-btn" onclick="showTab('add')">ğŸ“ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†</button>
        <button class="nav-btn" onclick="showTab('admin')">ğŸ” Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
    </div>
</header>

<div class="container no-print">

    <div id="home-view">
        <div style="margin-bottom: 20px; text-align: center;">
            <h2 style="margin:0;">Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†</h2>
            <p id="todayDateDisplay" style="color: var(--secondary);">...</p>
        </div>
        <div id="activitiesList" class="grid-cards">
            </div>
    </div>

    <div id="add-view" class="hidden">
        <div class="form-card">
            <h2 style="text-align: center; margin-bottom: 20px; color: var(--primary);">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</h2>
            <input type="hidden" id="editId">
            
            <div class="form-group">
                <label>Ù†Ø§ÙˆÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</label>
                <input type="text" id="tName" placeholder="Ù†Ø§ÙˆÛŒ Ø³ÛŒØ§Ù†ÛŒ">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>ÙˆØ§Ù†Û• / Ø¨Ø§Ø¨Û•Øª</label>
                    <input type="text" id="tSubject">
                </div>
                <div class="form-group">
                    <label>Ú•Û†Ú˜</label>
                    <select id="tDay">
                        <option>Ø´Û•Ù…Ù…Û•</option><option>ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û•</option><option>Ø¯ÙˆÙˆØ´Û•Ù…Ù…Û•</option>
                        <option>Ø³ÛØ´Û•Ù…Ù…Û•</option><option>Ú†ÙˆØ§Ø±Ø´Û•Ù…Ù…Û•</option><option>Ù¾ÛÙ†Ø¬Ø´Û•Ù…Ù…Û•</option><option>Ù‡Û•ÛŒÙ†ÛŒ</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>ÙˆØ§Ù†Û•ÛŒ Ú†Û•Ù†Ø¯Û•Ù…</label>
                    <select id="tPeriod">
                        <option value="1">ÛŒÛ•Ú©Û•Ù…</option><option value="2">Ø¯ÙˆÙˆÛ•Ù…</option><option value="3">Ø³ÛÛŒÛ•Ù…</option>
                        <option value="4">Ú†ÙˆØ§Ø±Û•Ù…</option><option value="5">Ù¾ÛÙ†Ø¬Û•Ù…</option><option value="6">Ø´Û•Ø´Û•Ù…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø¨Û•Ø±ÙˆØ§Ø±</label>
                    <input type="date" id="tDate">
                </div>
            </div>

            <div class="form-group">
                <label>ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</label>
                <textarea id="tDesc" rows="4"></textarea>
            </div>

            <button class="btn-primary" id="submitBtn" onclick="saveActivity()">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†</button>
            <button class="btn-primary" id="cancelEditBtn" onclick="resetForm()" style="background:var(--secondary); margin-top:10px;" class="hidden">Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†Û•ÙˆÛ•</button>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <div id="pin-screen" class="form-card" style="text-align: center; max-width: 400px;">
            <h3>ğŸ”’ Ù†Ø§ÙˆÚ†Û•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</h3>
            <div class="form-group">
                <input type="password" id="adminPin" style="text-align: center; letter-spacing: 5px; font-size: 20px;" placeholder="****">
            </div>
            <button class="btn-primary" onclick="checkPin()">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
        </div>

        <div id="admin-dashboard" class="hidden">
            
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-icon" style="background: var(--primary);">ğŸ“Š</div>
                    <div class="stat-info">
                        <h3 id="statTotal">0</h3>
                        <p>Ú©Û†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</p>
                    </div>
                </div>
                <div class="stat-card green">
                    <div class="stat-icon" style="background: var(--success);">ğŸ“…</div>
                    <div class="stat-info">
                        <h3 id="statToday">0</h3>
                        <p>Ú†Ø§Ù„Ø§Ú©ÛŒ Ø¦Û•Ù…Ú•Û†</p>
                    </div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-icon" style="background: var(--warning);">ğŸ‘¥</div>
                    <div class="stat-info">
                        <h3 id="statTeachers">0</h3>
                        <p>Ù…Ø§Ù…Û†Ø³ØªØ§</p>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3>Ù„ÛŒØ³ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</h3>
                    <button onclick="logout()" style="background:#fee2e2; color:#ef4444; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ù…Ø§Ù…Û†Ø³ØªØ§</th>
                            <th>Ø¨Ø§Ø¨Û•Øª</th>
                            <th>Ú•Û†Ú˜ & Ø¨Û•Ø±ÙˆØ§Ø±</th>
                            <th>ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ</th>
                            <th>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th>
                        </tr>
                    </thead>
                    <tbody id="adminActivitiesList">
                        </tbody>
                </table>
            </div>

        </div>
    </div>

</div>

<div id="hafba-modal" class="hidden">
    <div class="modal-sidebar no-print">
        <h3 style="margin-top:0;">Ø¦Ø§Ù…Ø§Ø¯Û•Ú©Ø±Ø¯Ù†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</h3>
        <p style="font-size:0.9em; color:#666;">ØªÚ©Ø§ÛŒÛ• Ù¤ ÙˆÛÙ†Û• Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•:</p>
        <input type="file" id="adminImageInput" multiple accept="image/*" onchange="previewA4Images(this)">
        
        <div style="margin-top: auto; display:flex; flex-direction:column; gap:10px;">
            <button onclick="window.print()" class="btn-primary" style="background: var(--warning); color:black;">ğŸ–¨ï¸ Ù¾Ø±ÛÙ†Øª (Print)</button>
            <button onclick="saveAsJpeg()" class="btn-primary">ğŸ–¼ï¸ Ø³Û•ÛŒÚ¤ (JPEG)</button>
            <button onclick="closeHafba()" class="btn-primary" style="background: var(--danger);">âŒ Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <div class="modal-content">
        <div class="a4-page" id="capture-area">
            <div class="doc-header">
                <div class="doc-logo"><img src="https://i.ibb.co/VY75GyWf/logo.png"></div>
                <div class="doc-title">
                    <h1>Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ÛŒ Ø¨Ù†Û•Ú•Û•ØªÛŒ</h1>
                    <p>ÙÛ†Ú•Ù…ÛŒ Ø¨Û•Ø¯ÙˆØ§Ø¯Ø§Ú†ÙˆÙˆÙ†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ Ú•Û†Ú˜Ø§Ù†Û•ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</p>
                </div>
                <div class="doc-logo" style="opacity:0"><img src="https://i.ibb.co/VY75GyWf/logo.png"></div>
            </div>

            <div class="doc-info-box">
                <div class="info-row">
                    <span class="info-label">Ù†Ø§ÙˆÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§:</span>
                    <span class="info-val" id="p-teacher">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ø¨Ø§Ø¨Û•Øª / ÙˆØ§Ù†Û•:</span>
                    <span class="info-val" id="p-subject">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ú•Û†Ú˜ Ùˆ Ø¨Û•Ø±ÙˆØ§Ø±:</span>
                    <span class="info-val" id="p-date-full">...</span>
                </div>
                 <div class="info-row">
                    <span class="info-label">ÙˆØ§Ù†Û•ÛŒ:</span>
                    <span class="info-val" id="p-period">...</span>
                </div>
            </div>

            <div class="doc-desc">
                <strong>ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ùˆ ØªÛØ¨ÛŒÙ†ÛŒ:</strong><br><br>
                <span id="p-desc">...</span>
            </div>

            <div class="doc-grid" id="p-images-grid">
                <div class="doc-img">ÙˆÛÙ†Û•ÛŒ Ù¡</div>
                <div class="doc-img">ÙˆÛÙ†Û•ÛŒ Ù¢</div>
                <div class="doc-img">ÙˆÛÙ†Û•ÛŒ Ù£</div>
                <div class="doc-img">ÙˆÛÙ†Û•ÛŒ Ù¤</div>
            </div>

            <div class="doc-footer">
                <p>Ù¾Û•Ø±ÙˆÛ•Ø±Ø¯Û•ÛŒ Ú•Ø§Ù†ÛŒÛ• - Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ â€¢ Ø¨Û•Ú•ÛÙˆØ¨Û•Ø±Ø§ÛŒÛ•ØªÛŒ</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, updateDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDI8eXKnSRh7EVmImQSHsaL-RUPQBikj0I",
        authDomain: "gzngschool-2b3eb.firebaseapp.com",
        projectId: "gzngschool-2b3eb",
        storageBucket: "gzngschool-2b3eb.firebasestorage.app",
        messagingSenderId: "975432723584",
        appId: "1:975432723584:web:4a5ae43fadff143b558a65",
        measurementId: "G-1YY22QS0MF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const SCHOOL_PIN = "2024";
    let allActs = [];

    window.showTab = (tab) => {
        ['home', 'add', 'admin'].forEach(t => document.getElementById(t+'-view').classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab+'-view').classList.remove('hidden');
        
        const btns = document.querySelectorAll('.nav-btn');
        if(tab==='home') btns[0].classList.add('active');
        if(tab==='add') { btns[1].classList.add('active'); document.getElementById('tDate').valueAsDate = new Date(); }
        if(tab==='admin') btns[2].classList.add('active');
    }

    const getTodayName = () => ['ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û•','Ø¯ÙˆÙˆØ´Û•Ù…Ù…Û•','Ø³ÛØ´Û•Ù…Ù…Û•','Ú†ÙˆØ§Ø±Ø´Û•Ù…Ù…Û•','Ù¾ÛÙ†Ø¬Ø´Û•Ù…Ù…Û•','Ù‡Û•ÛŒÙ†ÛŒ','Ø´Û•Ù…Ù…Û•'][new Date().getDay()];
    document.getElementById('todayDateDisplay').innerText = `Ø¦Û•Ù…Ú•Û†: ${getTodayName()} (${new Date().toLocaleDateString('ku-IQ')})`;

    window.saveActivity = async () => {
        const btn = document.getElementById('submitBtn');
        const editId = document.getElementById('editId').value;
        const name = document.getElementById('tName').value;
        const sub = document.getElementById('tSubject').value;
        const day = document.getElementById('tDay').value;
        const per = document.getElementById('tPeriod').value;
        const date = document.getElementById('tDate').value;
        const desc = document.getElementById('tDesc').value;

        if(!name || !sub || !date || !desc) return alert("âš ï¸ ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•");

        btn.innerText = "Ø¬Ø§Ø±ÛŒ Ø¯Û•Ù†ÛØ±ÛØª... â³";
        btn.disabled = true;

        try {
            const payload = {
                teacherName: name, subject: sub, dayOfWeek: day, 
                period: per, date: date, description: desc, 
                timestamp: new Date()
            };

            if(editId) {
                await updateDoc(doc(db, "activities", editId), payload);
                alert("âœ… Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù†ÙˆÛÚ©Ø±Ø§Ù†Û•ÙˆÛ•!");
            } else {
                await addDoc(collection(db, "activities"), payload);
                alert("âœ… Ú†Ø§Ù„Ø§Ú©ÛŒ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§!");
            }
            resetForm();
            window.showTab('home');
        } catch(e) { alert("Ù‡Û•ÚµÛ•: " + e.message); }
        btn.innerText = "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†";
        btn.disabled = false;
    }

    window.resetForm = () => {
        document.getElementById('editId').value = "";
        document.getElementById('tName').value = "";
        document.getElementById('tSubject').value = "";
        document.getElementById('tDesc').value = "";
        document.getElementById('tDate').valueAsDate = new Date();
        document.getElementById('submitBtn').innerText = "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†";
        document.getElementById('cancelEditBtn').classList.add('hidden');
    }

    const q = query(collection(db, "activities"), orderBy("date", "desc"));
    onSnapshot(q, (snap) => {
        allActs = [];
        const homeList = document.getElementById('activitiesList');
        const adminList = document.getElementById('adminActivitiesList');
        homeList.innerHTML = ""; adminList.innerHTML = "";
        
        let todayCount = 0;
        const todayStr = new Date().toISOString().split('T')[0];
        const uniqueTeachers = new Set();

        snap.forEach(d => {
            const data = {id: d.id, ...d.data()};
            allActs.push(data);
            uniqueTeachers.add(data.teacherName);
            if(data.date === todayStr) todayCount++;

            // Public Grid
            homeList.innerHTML += `
                <div class="public-card">
                    <div class="pc-head">
                        <strong>ğŸ‘¤ ${data.teacherName}</strong>
                        <span style="font-size:0.8em; color:#777;">${data.date}</span>
                    </div>
                    <div class="pc-body">
                        <div class="pc-meta">
                            <span class="badge">ğŸ“š ${data.subject}</span>
                            <span class="badge">ğŸ“… ${data.dayOfWeek}</span>
                            <span class="badge">â° ÙˆØ§Ù†Û•ÛŒ ${data.period}</span>
                        </div>
                        <p>${data.description}</p>
                    </div>
                </div>
            `;

            // Admin Table Row
            adminList.innerHTML += `
                <tr>
                    <td><strong>${data.teacherName}</strong></td>
                    <td><span class="status-badge">${data.subject}</span></td>
                    <td>${data.date}<br><small>${data.dayOfWeek}</small></td>
                    <td>${data.description.substring(0, 30)}...</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-icon print" onclick="openHafba('${data.id}')" title="Print Report">ğŸ–¨ï¸</button>
                            <button class="btn-icon" onclick="editAct('${data.id}')" title="Edit">âœï¸</button>
                            <button class="btn-icon delete" onclick="delAct('${data.id}')" title="Delete">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        if(allActs.length === 0) homeList.innerHTML = "<p>Ù‡ÛŒÚ† Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</p>";
        
        // Update Stats
        document.getElementById('statTotal').innerText = allActs.length;
        document.getElementById('statToday').innerText = todayCount;
        document.getElementById('statTeachers').innerText = uniqueTeachers.size;
    });

    // Hafba (Formal Report)
    window.openHafba = (id) => {
        const act = allActs.find(a => a.id === id);
        if(!act) return;
        document.getElementById('p-teacher').innerText = act.teacherName;
        document.getElementById('p-subject').innerText = act.subject;
        document.getElementById('p-date-full').innerText = act.dayOfWeek + " (" + act.date + ")";
        document.getElementById('p-period').innerText = act.period;
        document.getElementById('p-desc').innerText = act.description;
        
        document.getElementById('adminImageInput').value = "";
        document.getElementById('p-images-grid').innerHTML = `
            <div class="doc-img">ÙˆÛÙ†Û•</div><div class="doc-img">ÙˆÛÙ†Û•</div>
            <div class="doc-img">ÙˆÛÙ†Û•</div><div class="doc-img">ÙˆÛÙ†Û•</div>
        `;
        document.getElementById('hafba-modal').classList.remove('hidden');
    }

    window.previewA4Images = (input) => {
        const grid = document.getElementById('p-images-grid');
        grid.innerHTML = "";
        if (input.files && input.files.length > 0) {
            Array.from(input.files).slice(0, 4).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => grid.innerHTML += `<div class="doc-img"><img src="${e.target.result}"></div>`;
                reader.readAsDataURL(file);
            });
        }
    }

    window.saveAsJpeg = () => {
        html2canvas(document.getElementById("capture-area"), { scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement("a");
            link.download = "Report.jpg";
            link.href = canvas.toDataURL("image/jpeg");
            link.click();
        });
    }

    window.closeHafba = () => document.getElementById('hafba-modal').classList.add('hidden');
    window.checkPin = () => {
        if(document.getElementById('adminPin').value === SCHOOL_PIN) {
            document.getElementById('pin-screen').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
        } else alert("Ú©Û†Ø¯ Ù‡Û•ÚµÛ•ÛŒÛ•");
    }
    window.logout = () => location.reload();
    window.delAct = async(id) => { if(confirm("Ø¨ÛŒØ³Ú•Ù…Û•ÙˆÛ•ØŸ")) await deleteDoc(doc(db,"activities",id)); }
    window.editAct = (id) => {
        const a = allActs.find(x=>x.id===id);
        if(!a) return;
        document.getElementById('editId').value = a.id;
        document.getElementById('tName').value = a.teacherName;
        document.getElementById('tSubject').value = a.subject;
        document.getElementById('tDay').value = a.dayOfWeek;
        document.getElementById('tPeriod').value = a.period;
        document.getElementById('tDate').value = a.date;
        document.getElementById('tDesc').value = a.description;
        document.getElementById('submitBtn').innerText = "Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•";
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        document.getElementById('hafba-modal').classList.add('hidden');
        showTab('add'); 
    }
</script>
</body>
</html>
